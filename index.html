<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Covid-19 Tracker (World)</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style type="text/css">
      .tooltip {
        position: absolute;
        background-color: white;
        border: 1px solid #ddd;
        padding: 10px;
        display: none;
        left: 0px;
        top: 0px;
        font-size: 12px;
      }

      .tooltip div {
        margin-bottom: 5px;
      }

      .tooltip span {
        font-weight: bold;
      }

      #legend-container {
        padding: 10px;
        width: 100%;
        height: 10%;
        align-items: center;
        vertical-align: middle;
        text-align: center;
      }

      body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
      }

      #left-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #d9d7d7;
        padding: 10px;
      }

      #upper-part {
        height: 10%;
        width: 70%;
        color: #a10b0b;
        border-radius: 1%;
        padding: 5%;
        text-align: center;
      }

      #map-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #d9d7d7;
      }

      #map {
        margin: 0 auto;
        display: block;
      }

      #chart-container {
        display: flex;
        flex-direction: column;
        text-align: center;
        padding: 8px;
        font-weight: bold;
        position: relative;
      }

      .graph {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div id="left-container">
      <div id="upper-part">
        <font size="30">Covid-19 Tracker (World)</font>
        <br />
        January 2020 - October 2020
      </div>
      <div id="map-container">
        <svg id="map" width="400" height="300"></svg>
      </div>
      <div id="legend-container"></div>
      <div style="height: 5%; text-align: center">
        Data Source:
        <a
          target="_blank"
          href="https://www.kaggle.com/datasets/niketchauhan/covid-19-time-series-data/data?select=time-series-19-covid-combined.csv"
          >Kaggle</a
        >
        <br />
        <i style="color: red"
          >If the Colors appear same across the map, kindly refresh the page.
          Rendering issues may occur occassionaly due to large dataset.</i
        >
      </div>
    </div>

    <div id="chart-container">
      <div id="dropdowns-container">
        <div>
          <label for="country-dropdown">Country:* </label>
          <select id="country-dropdown" multiple></select>
          <label for="caseTypeDropdown">Type: </label>
          <select id="caseTypeDropdown"></select>
          <button id="reset-button">Reset All</button>
          <br />
          <i style="font-size: 10px"
            >* Hold Command / CTRL for Multiple Selections.</i
          >
        </div>
      </div>
      <hr width="100%" />
      Confirmed Cases<svg id="total-cases-chart"></svg>
      <hr width="100%" />
      Confirmed Recoveries<svg id="total-recoveries-chart"></svg>
      <hr width="100%" />
      Confirmed Deaths<svg id="total-deaths-chart"></svg>
      <div id="tooltip1" class="tooltip" style="text-align: left">
        <div>Date: <span id="date"></span></div>
        <div><span id="cases"></span></div>
      </div>
    </div>

    <script type="text/javascript">
      const totalConfirmedCases = {
        Canada: 0,
        Australia: 0,
        China: 0,
        Denmark: 0,
        France: 0,
        Netherlands: 0,
        "United Kingdom": 0,
      };
      const totalRecovered = {};
      const totalDeaths = {};
      var prevCases = 0;
      var prevRecovered = 0;
      var prevDeaths = 0;
      var dataset = null;
      d3.csv("covid-data_1.csv").then(function (data) {
        dataset = data;
        data.forEach(function (d) {
          d.country = d["Country"];
          d.confirmedCases = +d.Confirmed;
          d.recoveries = +d.Recovered;
          d.deaths = +d.Deaths;
          d.date = new Date(d.Date);
          d.activeCases = d.Confirmed - prevCases;
          prevCases = d.Confirmed;
          d.activeCases = d.Recovered - prevRecovered;
          prevRecovered = d.Recovered;
          d.activeCases = d.Deaths - prevDeaths;
          prevDeaths = d.Deaths;

          if (d.Date == "2020-10-17") {
            if (d["Province"]) {
              totalConfirmedCases[d.country] += d.confirmedCases;
              totalRecovered[d.country] += d.confirmedCases;
              totalDeaths[d.country] += d.confirmed;
            } else {
              totalConfirmedCases[d.country] = d.confirmedCases;
              totalRecovered[d.country] = d.confirmedCases;
              totalDeaths[d.country] = d.confirmed;
            }
          }
        });
      });

      var x = [];

      d3.json("custom.geo.json").then(function (world) {
        createMap(world, totalConfirmedCases);
      });

      function calculateTotalCases(date0, date1) {
        updatedTotalCases = {};
        dataset.forEach(function (d) {
          updatedTotalCases[d.country] = 0;
        });

        dataset.forEach(function (d) {
          d.confirmedCases = +d.Confirmed;
          d.country = d["Country"];
          if (
            d.date.getFullYear() === date0.getFullYear() &&
            d.date.getMonth() === date0.getMonth() &&
            d.date.getDate() === date0.getDate()
          ) {
            updatedTotalCases[d.country] =
              updatedTotalCases[d.country] - d.confirmedCases;
          }
          if (
            d.date.getFullYear() === date1.getFullYear() &&
            d.date.getMonth() === date1.getMonth() &&
            d.date.getDate() === date1.getDate()
          ) {
            updatedTotalCases[d.country] =
              updatedTotalCases[d.country] + d.confirmedCases;
          }
        });

        d3.json("custom.geo.json").then(function (world) {
          const legendContainer = d3.select("#legend-container");
          const legend = legendContainer.select("*").remove();
          createMap(world, updatedTotalCases);
        });
      }

      function createMap(world, data) {
        const width = window.innerWidth * 0.6;
        const height = width * 0.6;
        var x = [];

        const svg = d3
          .select("#map")
          .attr("width", width)
          .attr("height", height);

        const projection = d3.geoMercator().fitSize([width, height], world);
        const path = d3.geoPath().projection(projection);

        const dataValues = Object.values(data).map((value) => +value);
        const legendContainer = d3.select("#legend-container");
        const legendWidth = 700;
        const legendHeight = 20;
        const legendX = 10;
        const legendY = 10;

        const logDataValues = dataValues.map((value) => value + 1);

        const logScale = d3
          .scaleLog()
          .base(10)
          .domain([1, d3.max(logDataValues)])
          .range([0, 1]);

        const colorScale = d3.scaleSequential((d) =>
          d3.interpolateReds(logScale(d))
        );

        const legendScale = d3
          .scaleLog()
          .base(10)
          .domain([1, d3.max(logDataValues)])
          .range([0, legendWidth]);

        const legendColorScale = d3
          .scaleSequential(d3.interpolateReds)
          .domain([0, 1]);

        const legend = legendContainer
          .append("svg")
          .attr("width", legendWidth)
          .attr("height", legendHeight)
          .append("g")
          .attr("transform", `translate(${legendX},${legendY})`);

        legend
          .append("rect")
          .attr("width", legendWidth)
          .attr("height", legendHeight)
          .attr("fill", "url(#legend-gradient)");

        const gradient = legend
          .append("defs")
          .append("linearGradient")
          .attr("id", "legend-gradient")
          .attr("gradientUnits", "userSpaceOnUse")
          .attr("x1", 0)
          .attr("y1", 0)
          .attr("x2", legendWidth)
          .attr("y2", 0);

        gradient
          .selectAll("stop")
          .data(d3.range(0, 1.01, 0.01))
          .enter()
          .append("stop")
          .attr("offset", (d) => d * 100 + "%")
          .attr("stop-color", (d) => legendColorScale(d));

        legend
          .append("text")
          .attr("x", 0)
          .attr("y", legendHeight + 10)
          .text(d3.format(".2s")(legendScale.domain()[0]));

        legend
          .append("text")
          .attr("x", legendWidth)
          .attr("y", legendHeight + 10)
          .text(d3.format(".2s")(legendScale.domain()[1]));

        const xAxisScale = legendScale;

        const numTicks = 5;

        const tickValues = xAxisScale.ticks(numTicks);

        const ticks = legend
          .selectAll(".tick")
          .data(tickValues)
          .enter()
          .append("g")
          .attr("class", "tick")
          .attr("transform", (d) => `translate(${xAxisScale(d)}, 0)`);

        ticks.append("line").attr("y1", 0).attr("y2", 5).attr("stroke", "#000");

        ticks
          .append("text")
          .attr("y", (-4 / 5) * legendHeight)
          .attr("dy", "1em")
          .attr("text-anchor", "middle")
          .text((d) => d3.format(".2s")(d));

        svg
          .append("g")
          .selectAll("path")
          .data(world.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill", function (d) {
            const countryName = d.properties.name;
            return colorScale(data[countryName] || 1);
          })
          .attr("stroke", "#000")
          .attr("stroke-width", 0.2)
          .on("mouseover", function (event, d) {
            d3.select(this).attr("stroke", "white").attr("stroke-width", 2);
          })
          .on("mouseout", function () {
            d3.select(this).attr("stroke", "#000").attr("stroke-width", 0.2);
          })
          .on("click", function (d) {
            if (d.properties.name == "Australia") {
              d3.select("#country-dropdown").property(
                "value",
                "[Australia] Australian Capital Territory"
              );
            } else if (d.properties.name == "Canada") {
              d3.select("#country-dropdown").property(
                "value",
                "[Canada] Alberta"
              );
            } else if (d.properties.name == "China") {
              d3.select("#country-dropdown").property("value", "[China] Anhui");
            } else if (d.properties.name == "Denmark") {
              d3.select("#country-dropdown").property(
                "value",
                "[Denmark] Faroe Islands"
              );
            } else if (d.properties.name == "France") {
              d3.select("#country-dropdown").property(
                "value",
                "[France] French Guiana"
              );
            } else if (d.properties.name == "Netherlands") {
              d3.select("#country-dropdown").property(
                "value",
                "[Netherlands] Aruba"
              );
            } else if (d.properties.name == "United Kingdom") {
              d3.select("#country-dropdown").property(
                "value",
                "[United Kingdom] Anguilla"
              );
            } else {
              d3.select("#country-dropdown").property(
                "value",
                d.properties.name
              );
            }
            d3.select("#country-dropdown").dispatch("change");
            d3.select(this).attr("stroke", "blue").attr("stroke-width", 2);
          })
          .append("title")
          .text(function (d) {
            const countryName = d.properties.name;
            return `Country: ${countryName}, Confirmed Cases: ${data[countryName] || 0}`;
          });
      }
    </script>

    <script type="text/javascript">
      var prevCases = 0;
      var prevRecovered = 0;
      var prevDeaths = 0;
      var prevCountry = "";
      d3.csv("covid-data_1.csv").then(function (data) {
        data.forEach((d) => {
          d.cases = +d.Confirmed;
          d.deaths = +d.Deaths;
          d.recoveries = +d.Recovered;
          d.date = new Date(d.Date);
          d.country = d["Province"]
            ? "[" + d.Country + "] " + d["Province"]
            : d.Country;
          d.state = d["Province"] ? d.Province : "";
          if (!(prevCountry === d.country)) {
            prevCases = 0;
            prevRecovered = 0;
            prevDeaths = 0;
            prevCountry = d.country;
          }

          d.dailyCases = d.Confirmed < prevCases ? 0 : d.Confirmed - prevCases;
          prevCases = d.Confirmed;
          d.dailyRecovered =
            d.Recovered < prevDeaths ? 0 : d.Recovered - prevRecovered;
          prevRecovered = d.Recovered;
          d.dailyDeaths = d.Deaths < prevDeaths ? 0 : d.Deaths - prevDeaths;
          prevDeaths = d.Deaths;
        });
        const countries = Array.from(
          new Set(
            data.map((d) =>
              d["Province"] ? "[" + d.Country + "] " + d["Province"] : d.Country
            )
          )
        );

        var selectCountryGlobal = [countries[0]];
        const dropdown = d3.select("#country-dropdown");
        dropdown
          .selectAll("option")
          .data(countries)
          .enter()
          .append("option")
          .text((d) => d)
          .attr("value", (d) => d);

        const margin = { top: 20, right: 20, bottom: 30, left: 50 };
        const width = window.innerWidth * 0.36 - margin.left - margin.right;
        const height = width * 0.42 - margin.top - margin.bottom;

        const xCases = d3.scaleTime().range([0, width]);
        const yCases = d3.scaleLinear().range([height, 0]);

        const xCasesAxis = d3
          .axisBottom(xCases)
          .tickFormat(d3.timeFormat("%d %b"))
          .ticks(6);
        const yCasesAxis = d3.axisLeft(yCases);

        const xRecov = d3.scaleTime().range([0, width]);
        const yRecov = d3.scaleLinear().range([height, 0]);

        const xRecovAxis = d3
          .axisBottom(xRecov)
          .tickFormat(d3.timeFormat("%d %b"))
          .ticks(6);
        const yRecovAxis = d3.axisLeft(yRecov);

        const xDeaths = d3.scaleTime().range([0, width]);
        const yDeaths = d3.scaleLinear().range([height, 0]);

        const xDeathsAxis = d3
          .axisBottom(xDeaths)
          .tickFormat(d3.timeFormat("%d %b"))
          .ticks(6);
        const yDeathsAxis = d3.axisLeft(yDeaths);

        const svgCases = d3
          .select("#total-cases-chart")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        const svgRecov = d3
          .select("#total-recoveries-chart")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        const svgDeaths = d3
          .select("#total-deaths-chart")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        const dateExtentCases = d3.extent(data.map((d) => new Date(d.Date)));
        const dateExtentDeaths = d3.extent(data.map((d) => new Date(d.Date)));

        const caseTypeDropdown = d3.select("#caseTypeDropdown");

        const caseTypeOptions = ["Cumulative", "Daily"];

        caseTypeDropdown
          .selectAll("option")
          .data(caseTypeOptions)
          .enter()
          .append("option")
          .text((d) => d)
          .attr("value", (d) => d);

        var selectedValue = null;

        caseTypeDropdown.on("change", function () {
          selectedValue = d3.select(this).property("value");
        });

        if (selectedValue === "Cumulative") {
          xCases.domain(dateExtentCases);
          yCases.domain([0, d3.max(data, (d) => d.cases)]);

          xRecov.domain(dateExtentCases);
          yRecov.domain([0, d3.max(data, (d) => d.recoveries)]);

          xDeaths.domain(dateExtentDeaths);
          yDeaths.domain([0, d3.max(data, (d) => d.deaths)]);
        } else if (selectedValue === "Daily") {
          xCases.domain(dateExtentCases);
          yCases.domain([0, d3.max(data, (d) => d.dailyCases)]);

          xRecov.domain(dateExtentCases);
          yRecov.domain([0, d3.max(data, (d) => d.dailyRecovered)]);

          xDeaths.domain(dateExtentDeaths);
          yDeaths.domain([0, d3.max(data, (d) => d.dailyDeaths)]);
        }

        dropdown.property("value", countries[0]);
        updateGraph(
          [countries[0]],
          svgCases,
          xCases,
          yCases,
          xCasesAxis,
          yCasesAxis,
          "cases"
        );
        updateGraph(
          [countries[0]],
          svgRecov,
          xRecov,
          yRecov,
          xRecovAxis,
          yRecovAxis,
          "recov"
        );
        updateGraph(
          [countries[0]],
          svgDeaths,
          xDeaths,
          yDeaths,
          xDeathsAxis,
          yDeathsAxis,
          "deaths"
        );

        function updateGraph(
          selectedCountry,
          svg,
          x,
          y,
          xAxis,
          yAxis,
          type,
          filteredByDate,
          d0,
          d1
        ) {
          svg.selectAll("*").remove();
          selectedC = selectedCountry;
          const allUniqueDates = [];
          const maxValues = [];
          toolText = "";
          const caseTypeDropdown = d3.select("#caseTypeDropdown");
          var selectedValue = caseTypeDropdown.property("value");

          if (selectedValue === "Cumulative") {
            selectedC.forEach((country) => {
              selectedCountry = country;
              if (selectedCountry[0] == "[") {
                state = selectedCountry.split("] ")[1];
                var filteredData = filteredByDate
                  ? data.filter((d) =>
                      filteredByDate.some(
                        (dateObj) =>
                          dateObj.date.getTime() === d.date.getTime() &&
                          dateObj.country === d.country &&
                          dateObj.state === state &&
                          dateObj.country === selectedCountry
                      )
                    )
                  : data.filter(
                      (d) => d.country === selectedCountry && d.state === state
                    );
              } else {
                var filteredData = filteredByDate
                  ? data.filter(
                      (d) =>
                        d.date >= d0 &&
                        d.date <= d1 &&
                        d.country === selectedCountry
                    )
                  : data.filter((d) => d.country === selectedCountry);
              }
              const uniqueDates = Array.from(
                new Set(filteredData.map((d) => d.date.getTime()))
              );
              allUniqueDates.push(...uniqueDates);

              const maxCountryValue = d3.max(filteredData, (d) =>
                type === "cases"
                  ? d.cases
                  : type === "deaths"
                  ? d.deaths
                  : d.recoveries
              );
              maxValues.push(maxCountryValue);
            });
            uniqueDates = allUniqueDates;
            x.domain([d3.min(uniqueDates), d3.max(uniqueDates)]);

            y.domain([0, d3.max(maxValues)]);
          } else if (selectedValue === "Daily") {
            selectedC.forEach((country) => {
              selectedCountry = country;
              if (selectedCountry[0] == "[") {
                state = selectedCountry.split("] ")[1];
                var filteredData = filteredByDate
                  ? data.filter((d) =>
                      filteredByDate.some(
                        (dateObj) =>
                          dateObj.date.getTime() === d.date.getTime() &&
                          dateObj.country === d.country &&
                          dateObj.state === state &&
                          dateObj.country === selectedCountry
                      )
                    )
                  : data.filter(
                      (d) => d.country === selectedCountry && d.state === state
                    );
              } else {
                var filteredData = filteredByDate
                  ? data.filter(
                      (d) =>
                        d.date >= d0 &&
                        d.date <= d1 &&
                        d.country === selectedCountry
                    )
                  : data.filter((d) => d.country === selectedCountry);
              }
              const uniqueDates = Array.from(
                new Set(filteredData.map((d) => d.date.getTime()))
              );
              allUniqueDates.push(...uniqueDates);

              const maxCountryValue = d3.max(filteredData, (d) =>
                type === "cases"
                  ? d.dailyCases
                  : type === "deaths"
                  ? d.dailyDeaths
                  : d.dailyRecovered
              );
              maxValues.push(maxCountryValue);
            });
            uniqueDates = allUniqueDates;
            x.domain([d3.min(uniqueDates), d3.max(uniqueDates)]);
            y.domain([0, d3.max(maxValues)]);
          }

          svg
            .append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

          svg.append("g").call(yAxis);

          for (i = 0; i < selectedC.length; i++) {
            selectedCountry = selectedC[i];
            var filteredData = "";
            if (selectedCountry[0] == "[") {
              state = selectedCountry.split("] ")[1];
              var filteredData = filteredByDate
                ? data.filter((d) =>
                    filteredByDate.some(
                      (dateObj) =>
                        dateObj.date.getTime() === d.date.getTime() &&
                        dateObj.country === d.country &&
                        dateObj.state === state &&
                        dateObj.country === selectedCountry
                    )
                  )
                : data.filter(
                    (d) => d.country === selectedCountry && d.state === state
                  );
            } else {
              var filteredData = filteredByDate
                ? data.filter(
                    (d) =>
                      d.date >= d0 &&
                      d.date <= d1 &&
                      d.country === selectedCountry
                  )
                : data.filter((d) => d.country === selectedCountry);
            }

            const line = d3.line();

            const countryColors = ["red", "blue", "green", "purple", "orange"];

            const colorLines = d3
              .scaleOrdinal()
              .domain(selectedC)
              .range(countryColors);

            if (selectedValue === "Cumulative") {
              line.y((d) =>
                y(
                  type === "cases"
                    ? d.cases
                    : type === "deaths"
                    ? d.deaths
                    : d.recoveries
                )
              );

              line.x((d) => x(d.date));
            } else if (selectedValue === "Daily") {
              // Add the line
              line.y((d) =>
                y(
                  type === "cases"
                    ? d.dailyCases
                    : type === "deaths"
                    ? d.dailyDeaths
                    : d.dailyRecovered
                )
              );
              line.x((d) => x(d.date));
            }

            const cursorLine = svg.select(".cursor-line");

            svg
              .append("path")
              .datum(filteredData)
              .attr("fill", "none")
              .attr("stroke", (d) => colorLines(selectedC[i]))
              .attr("stroke-linejoin", "round")
              .attr("stroke-linecap", "round")
              .attr("stroke-width", 2)
              .attr("d", line);

            if (selectedValue == "Cumulative") {
              if (type == "cases") {
                svg
                  .append("text")
                  .datum(filteredData[filteredData.length - 2])
                  .attr("transform", function (d) {
                    return "translate(" + x(d.date) + "," + y(d.cases) + ")";
                  })
                  .attr("x", -20)
                  .attr("y", 20)
                  .text(function (d) {
                    return d.country.substring(0, 3);
                  });
              } else if (type == "recov") {
                svg
                  .append("text")
                  .datum(filteredData[filteredData.length - 2])
                  .attr("transform", function (d) {
                    return (
                      "translate(" + x(d.date) + "," + y(d.recoveries) + ")"
                    );
                  })
                  .attr("x", -20)
                  .attr("y", 20)
                  .text(function (d) {
                    return d.country.substring(0, 3);
                  });
              } else if (type == "deaths") {
                svg
                  .append("text")
                  .datum(filteredData[filteredData.length - 2])
                  .attr("transform", function (d) {
                    return "translate(" + x(d.date) + "," + y(d.deaths) + ")";
                  })
                  .attr("x", -20)
                  .attr("y", 20)
                  .text(function (d) {
                    return d.country.substring(0, 3);
                  });
              }
            }

            if (selectedValue == "Daily") {
              if (type == "cases") {
                svg
                  .append("text")
                  .datum(filteredData[filteredData.length - 2])
                  .attr("transform", function (d) {
                    return (
                      "translate(" + x(d.date) + "," + y(d.dailyCases) + ")"
                    );
                  })
                  .attr("x", -20)
                  .attr("y", 20)
                  .text(function (d) {
                    return d.country.substring(0, 3);
                  });
              } else if (type == "recov") {
                svg
                  .append("text")
                  .datum(filteredData[filteredData.length - 2])
                  .attr("transform", function (d) {
                    return (
                      "translate(" + x(d.date) + "," + y(d.dailyRecovered) + ")"
                    );
                  })
                  .attr("x", -20)
                  .attr("y", 20)
                  .text(function (d) {
                    return d.country.substring(0, 3);
                  });
              } else if (type == "deaths") {
                svg
                  .append("text")
                  .datum(filteredData[filteredData.length - 2])
                  .attr("transform", function (d) {
                    return (
                      "translate(" + x(d.date) + "," + y(d.dailyDeaths) + ")"
                    );
                  })
                  .attr("x", -20)
                  .attr("y", 20)
                  .text(function (d) {
                    return d.country.substring(0, 3);
                  });
              }
            }

            const cursorLineCases = svgCases
              .append("line")
              .attr("class", "cursor-line")
              .attr("stroke", "black")
              .attr("stroke-width", 1)
              .attr("y1", 0)
              .attr("y2", height)
              .style("display", "none");

            const cursorLineCases2 = svgRecov
              .append("line")
              .attr("class", "cursor-line")
              .attr("stroke", "black")
              .attr("stroke-width", 1)
              .attr("y1", 0)
              .attr("y2", height)
              .style("display", "none");

            const cursorLineCases1 = svgDeaths
              .append("line")
              .attr("class", "cursor-line")
              .attr("stroke", "black")
              .attr("stroke-width", 1)
              .attr("y1", 0)
              .attr("y2", height)
              .style("display", "none");

            const tooltip1 = d3.select("#tooltip1");
            if (i == selectedC.length - 1) {
              svgCases
                .on("mouseover", function () {
                  cursorLineCases.style("display", null);
                  tooltip1.style("display", "block");
                })
                .on("mouseout", function () {
                  cursorLineCases.style("display", "none");
                  tooltip1.style("display", "none");
                })
                .on("mousemove", function () {
                  tooltip1.select("#cases").text("");
                  toolText = "";
                  const [mouseX, mouseY] = d3.mouse(this);
                  //const [mouseX1, mouseY1] = d3.mouse();
                  selectedC.forEach((country) => {
                    selectedCountry = country;
                    if (selectedCountry[0] == "[") {
                      state = selectedCountry.split("] ")[1];
                      var filteredData = filteredByDate
                        ? data.filter((d) =>
                            filteredByDate.some(
                              (dateObj) =>
                                dateObj.date.getTime() === d.date.getTime() &&
                                dateObj.country === d.country &&
                                dateObj.state === state &&
                                dateObj.country === selectedCountry
                            )
                          )
                        : data.filter(
                            (d) =>
                              d.country === selectedCountry && d.state === state
                          );
                    } else {
                      var filteredData = filteredByDate
                        ? data.filter(
                            (d) =>
                              d.date >= d0 &&
                              d.date <= d1 &&
                              d.country === selectedCountry
                          )
                        : data.filter((d) => d.country === selectedCountry);
                    }
                    const dateValue = x.invert(mouseX);
                    const closestDataPoint = findClosestDataPoint(
                      dateValue,
                      filteredData
                    );
                    const formatDate = d3.timeFormat("%Y-%m-%d");
                    if (selectedValue === "Cumulative") {
                      toolText +=
                        selectedCountry +
                        ":" +
                        String(closestDataPoint.cases) +
                        ", ";
                    } else if (selectedValue === "Daily") {
                      toolText +=
                        selectedCountry +
                        ":" +
                        String(closestDataPoint.dailyCases) +
                        ", ";
                    }
                    tooltip1
                      .select("#date")
                      .text(formatDate(closestDataPoint.date));
                    tooltip1.select("#cases").text(toolText);

                    const svgCasesPosition = d3
                      .select("#total-cases-chart")
                      .node()
                      .getBoundingClientRect();
                    tooltip1
                      .style("left", mouseX + 75 + "px")
                      .style("top", mouseY + svgCasesPosition.top + "px");
                    cursorLineCases.attr(
                      "transform",
                      "translate(" + (mouseX - 2) + ", 0)"
                    );
                  });
                });

              svgRecov
                .on("mouseover", function () {
                  cursorLineCases2.style("display", null);
                  tooltip1.style("display", "block");
                })
                .on("mouseout", function () {
                  cursorLineCases2.style("display", "none");
                  tooltip1.style("display", "none");
                })
                .on("mousemove", function () {
                  tooltip1.select("#cases").text("");
                  toolText = "";
                  const [mouseX, mouseY] = d3.mouse(this);
                  selectedC.forEach((country) => {
                    selectedCountry = country;
                    if (selectedCountry[0] == "[") {
                      state = selectedCountry.split("] ")[1];
                      var filteredData = filteredByDate
                        ? data.filter((d) =>
                            filteredByDate.some(
                              (dateObj) =>
                                dateObj.date.getTime() === d.date.getTime() &&
                                dateObj.country === d.country &&
                                dateObj.state === state &&
                                dateObj.country === selectedCountry
                            )
                          )
                        : data.filter(
                            (d) =>
                              d.country === selectedCountry && d.state === state
                          );
                    } else {
                      var filteredData = filteredByDate
                        ? data.filter(
                            (d) =>
                              d.date >= d0 &&
                              d.date <= d1 &&
                              d.country === selectedCountry
                          )
                        : data.filter((d) => d.country === selectedCountry);
                    }
                    const dateValue = x.invert(mouseX);
                    const closestDataPoint = findClosestDataPoint(
                      dateValue,
                      filteredData
                    );
                    const formatDate = d3.timeFormat("%Y-%m-%d");
                    if (selectedValue === "Cumulative") {
                      toolText +=
                        selectedCountry +
                        ":" +
                        String(closestDataPoint.recoveries) +
                        ", ";
                    } else if (selectedValue === "Daily") {
                      toolText +=
                        selectedCountry +
                        ":" +
                        String(closestDataPoint.dailyRecovered) +
                        ", ";
                    }
                    tooltip1
                      .select("#date")
                      .text(formatDate(closestDataPoint.date));
                    tooltip1.select("#cases").text(toolText);
                    const svgCasesPosition2 = d3
                      .select("#total-recoveries-chart")
                      .node()
                      .getBoundingClientRect();
                    tooltip1
                      .style("left", mouseX + 75 + "px")
                      .style("top", mouseY + svgCasesPosition2.top + "px");
                    cursorLineCases2.attr(
                      "transform",
                      "translate(" + (mouseX - 2) + ", 0)"
                    );
                  });
                });
              svgDeaths
                .on("mouseover", function () {
                  cursorLineCases1.style("display", null);
                  tooltip1.style("display", "block");
                })
                .on("mouseout", function () {
                  cursorLineCases1.style("display", "none");
                  tooltip1.style("display", "none");
                })
                .on("mousemove", function () {
                  tooltip1.select("#cases").text("");
                  toolText = "";
                  const [mouseX, mouseY] = d3.mouse(this);
                  selectedC.forEach((country) => {
                    selectedCountry = country;
                    if (selectedCountry[0] == "[") {
                      state = selectedCountry.split("] ")[1];
                      var filteredData = filteredByDate
                        ? data.filter((d) =>
                            filteredByDate.some(
                              (dateObj) =>
                                dateObj.date.getTime() === d.date.getTime() &&
                                dateObj.country === d.country &&
                                dateObj.state === state &&
                                dateObj.country === selectedCountry
                            )
                          )
                        : data.filter(
                            (d) =>
                              d.country === selectedCountry && d.state === state
                          );
                    } else {
                      var filteredData = filteredByDate
                        ? data.filter(
                            (d) =>
                              d.date >= d0 &&
                              d.date <= d1 &&
                              d.country === selectedCountry
                          )
                        : data.filter((d) => d.country === selectedCountry);
                    }

                    const dateValue = x.invert(mouseX);
                    const closestDataPoint = findClosestDataPoint(
                      dateValue,
                      filteredData
                    );
                    const formatDate = d3.timeFormat("%Y-%m-%d");
                    if (selectedValue === "Cumulative") {
                      toolText +=
                        selectedCountry +
                        ":" +
                        String(closestDataPoint.deaths) +
                        ", ";
                    } else if (selectedValue === "Daily") {
                      toolText +=
                        selectedCountry +
                        ":" +
                        String(closestDataPoint.dailyDeaths) +
                        ", ";
                    }
                    tooltip1
                      .select("#date")
                      .text(formatDate(closestDataPoint.date));
                    tooltip1.select("#cases").text(toolText);

                    const svgCasesPosition1 = d3
                      .select("#total-deaths-chart")
                      .node()
                      .getBoundingClientRect();
                    tooltip1
                      .style("left", mouseX + 75 + "px")
                      .style("top", mouseY + svgCasesPosition1.top + "px");
                    cursorLineCases1.attr(
                      "transform",
                      "translate(" + (mouseX - 2) + ", 0)"
                    );
                  });
                });
              svgCases
                .append("text")
                .attr(
                  "transform",
                  "translate(" +
                    width / 2 +
                    " ," +
                    (height + margin.top + 10) +
                    ")"
                )
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .text("Date ---->");

              svgCases
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left - 4)
                .attr("x", 0 - height / 2)
                .attr("dy", "1em")
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .text("Cases ---->");

              svgRecov
                .append("text")
                .attr(
                  "transform",
                  "translate(" +
                    width / 2 +
                    " ," +
                    (height + margin.top + 10) +
                    ")"
                )
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .text("Date ---->");

              svgRecov
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left - 4)
                .attr("x", 0 - height / 2)
                .attr("dy", "1em")
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .text("Recovered ---->");

              svgDeaths
                .append("text")
                .attr(
                  "transform",
                  "translate(" +
                    width / 2 +
                    " ," +
                    (height + margin.top + 10) +
                    ")"
                )
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .text("Date ---->");

              svgDeaths
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left - 4)
                .attr("x", 0 - height / 2)
                .attr("dy", "1em")
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .text("Deaths ---->");
            }
          }

          const brush = d3
            .brushX()
            .extent([
              [0, 0],
              [width, height],
            ])
            .on("end", brushed);

          svg.append("g").attr("class", "brush").call(brush);

          const resetButton = d3.select("#reset-button");

          function resetBrush() {
            // Remove the brush selection
            svgCases.select(".brush").call(brush.move, null);
            svgRecov.select(".brush").call(brush.move, null);
            svgDeaths.select(".brush").call(brush.move, null);
            dropdown.property("value", countries[0]);
            updateGraph(
              [countries[0]],
              svgCases,
              xCases,
              yCases,
              xCasesAxis,
              yCasesAxis,
              "cases"
            );
            updateGraph(
              [countries[0]],
              svgRecov,
              xRecov,
              yRecov,
              xRecovAxis,
              yRecovAxis,
              "recov"
            );
            updateGraph(
              [countries[0]],
              svgDeaths,
              xDeaths,
              yDeaths,
              xDeathsAxis,
              yDeathsAxis,
              "deaths"
            );
            d3.json("custom.geo.json").then(function (world) {
              const legendContainer = d3.select("#legend-container");
              const legend = legendContainer.select("*").remove();
              createMap(world, totalConfirmedCases);
            });
          }

          resetButton.on("click", resetBrush);

          function brushed() {
            const selection = d3.event.selection;
            if (!selection) return;
            const [x0, x1] = selection.map(x.invert);
            const filteredByDate = "c";
            updateGraph(
              selectCountryGlobal,
              svgCases,
              xCases,
              yCases,
              xCasesAxis,
              yCasesAxis,
              "cases",
              filteredByDate,
              x0,
              x1
            );
            updateGraph(
              selectCountryGlobal,
              svgRecov,
              xRecov,
              yRecov,
              xRecovAxis,
              yRecovAxis,
              "recov",
              filteredByDate,
              x0,
              x1
            );
            updateGraph(
              selectCountryGlobal,
              svgDeaths,
              xDeaths,
              yDeaths,
              xDeathsAxis,
              yDeathsAxis,
              "deaths",
              filteredByDate,
              x0,
              x1
            );
            calculateTotalCases(x0, x1);
          }

          function findClosestDataPoint(date, data) {
            const bisectDate = d3.bisector((d) => d.date).left;
            const index = bisectDate(data, date, 1);
            const d0 = data[index - 1];
            const d1 = data[index];
            return date - d0.date > d1.date - date ? d1 : d0;
          }
        }

        dropdown.on("change", function () {
          const selectedOptions = Array.from(this.selectedOptions);
          selectCountryGlobal = selectedOptions.map((option) => option.value);
          updateGraph(
            selectCountryGlobal,
            svgCases,
            xCases,
            yCases,
            xCasesAxis,
            yCasesAxis,
            "cases"
          );
          updateGraph(
            selectCountryGlobal,
            svgRecov,
            xRecov,
            yRecov,
            xRecovAxis,
            yRecovAxis,
            "recov"
          );
          updateGraph(
            selectCountryGlobal,
            svgDeaths,
            xDeaths,
            yDeaths,
            xDeathsAxis,
            yDeathsAxis,
            "deaths"
          );
        });

        caseTypeDropdown.on("change", function () {
          updateGraph(
            selectCountryGlobal,
            svgCases,
            xCases,
            yCases,
            xCasesAxis,
            yCasesAxis,
            "cases"
          );
          updateGraph(
            selectCountryGlobal,
            svgRecov,
            xRecov,
            yRecov,
            xRecovAxis,
            yRecovAxis,
            "recov"
          );
          updateGraph(
            selectCountryGlobal,
            svgDeaths,
            xDeaths,
            yDeaths,
            xDeathsAxis,
            yDeathsAxis,
            "deaths"
          );
        });
      });
    </script>
  </body>
</html>
